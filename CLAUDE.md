# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is `lhd-retrieve`, a Python package for retrieving LHD (Large Helical Device) measurement data using the Retrieve.exe command-line tool on Windows systems. The package provides a Python interface to interact with the LHD data retrieval system used in plasma physics research.

## Development Commands

### Installation and Setup
```bash
# Install the package in development mode
pip install -e .

# Install with development dependencies
pip install -e .[dev]

# Install required dependencies only
pip install numpy pandas matplotlib
```

### Testing and Code Quality
```bash
# Run tests (if test framework is available)
pytest

# Code formatting
black lhd_retrieve/ examples/

# Linting
flake8 lhd_retrieve/ examples/
```

### Package Building
```bash
# Build the package
python setup.py build

# Create distribution
python setup.py sdist bdist_wheel
```

## Architecture

### Core Components

1. **LHDRetriever** (`lhd_retrieve/core.py:60-381`): Main class that wraps Retrieve.exe functionality
   - Handles command execution and subprocess management
   - Supports multiple data retrieval patterns
   - Manages temporary file operations and cleanup

2. **LHDData** (`lhd_retrieve/core.py:14-58`): Data container class
   - Encapsulates measurement data with metadata
   - Provides pandas integration and CSV export
   - Includes matplotlib plotting capabilities

3. **Utilities** (`lhd_retrieve/utils.py`): Environment validation and path management
   - Windows environment checks
   - Retrieve.exe path discovery and validation
   - System compatibility verification

### Key Design Patterns

- **Command Line Interface Wrapper**: The package acts as a Python wrapper around the Windows-only Retrieve.exe tool
- **Data Container Pattern**: Uses dataclass-based LHDData for structured data handling
- **Batch Processing Support**: Supports retrieval of multiple channels and shots in batches
- **Automatic Resource Management**: Handles temporary file creation and cleanup

### LHD-Specific Command Format

The package follows the LHD Retrieve.exe command structure:
```
Retrieve DiagName ShotNo SubShotNo ChNo-Name [FileName] [options]
```

Common options:
- `-T`: Generate time axis information
- `-V`: Convert to voltage values
- `-f`: Specify frame number

### Data Flow

1. Command construction in `_run_retrieve()` method
2. Subprocess execution with timeout handling  
3. File parsing from .dat, .prm, .time, and .tprm outputs
4. Data assembly into LHDData objects with all metadata
5. **Automatic cleanup of ALL temporary files** (`.dat`, `.prm`, `.time`, `.tprm`, etc.)

### Temporary File Management

The package ensures clean operation by:
- **Automatic detection** of all files generated by Retrieve.exe
- **Pattern-based cleanup** using glob patterns (`prefix*.dat`, `prefix*.prm`, etc.)
- **Robust error handling** - cleanup failures don't affect data retrieval
- **Memory preservation** - all data and metadata stored in LHDData objects
- **No file system pollution** - working directory remains clean after operations

### Common LHD Diagnostics

The system supports various plasma diagnostics including:
- Magnetics (Mag): Magnetic field measurements
- Thomson Scattering (TS): Electron temperature/density
- ECE: Electron cyclotron emission
- NBI: Neutral beam injection
- CXRS: Charge exchange recombination spectroscopy

## Platform Requirements

- **Windows Only**: Package is designed specifically for Windows systems
- **Retrieve.exe Dependency**: Requires LHD Retrieve.exe tool installation
- **Default Paths**: Looks for Retrieve.exe at `C:\LABCOM\Retrieve\bin\Retrieve.exe`

## Error Handling Patterns

- Comprehensive subprocess error handling with timeout support
- Multiple file format fallbacks (binary float32/float64, int16, text)
- Graceful degradation for missing time axis data
- Warning-based error reporting for non-critical failures

## Development Workflow

### Version Management

- **ALWAYS bump version before pushing to GitHub**
- Follow semantic versioning (MAJOR.MINOR.PATCH):
  - PATCH (0.1.0 → 0.1.1): Bug fixes, small improvements
  - MINOR (0.1.0 → 0.2.0): New features, backwards compatible
  - MAJOR (0.1.0 → 1.0.0): Breaking changes
- Update version in `pyproject.toml` before git push
- Create separate commit for version bump

### Git Workflow

```bash
# 1. Make code changes
# 2. Update version in pyproject.toml
git add pyproject.toml
git commit -m "Bump version to X.Y.Z"

# 3. Push changes
git push origin main
```